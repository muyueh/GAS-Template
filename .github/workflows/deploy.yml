name: Deploy to Apps Script

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: "apps-script-deploy"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Validate clasp config
        run: |
          if [ ! -f ".clasp.json" ]; then
            echo "::error::.clasp.json is missing. Copy .clasp.json.example and set scriptId before deploying."
            exit 1
          fi

          SCRIPT_ID=$(node -e "const fs = require('fs'); const path = '.clasp.json'; const json = JSON.parse(fs.readFileSync(path, 'utf8')); console.log((json.scriptId || '').trim());")

          if [ -z "$SCRIPT_ID" ] || [ "$SCRIPT_ID" = "REPLACE_WITH_SCRIPT_ID" ]; then
            echo "::error::.clasp.json scriptId is missing. Update scriptId with your Apps Script project ID and commit before deploying."
            exit 1
          fi

          echo "Detected scriptId in .clasp.json; continuing deployment."

      - name: Validate clasp auth secret
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          if [ -z "${CLASPRC_JSON:-}" ]; then
            echo "::error::Missing CLASPRC_JSON secret. Run 'npx clasp login --no-localhost' locally and add the resulting ~/.clasprc.json content as the CLASPRC_JSON repository secret."
            exit 1
          fi

          printf '%s' "$CLASPRC_JSON" > "$HOME/.clasprc.json"

          node - <<'NODE'
const fs = require('fs');
const path = `${process.env.HOME}/.clasprc.json`;
const data = JSON.parse(fs.readFileSync(path, 'utf8'));

const refreshToken = data.refresh_token || (data.token && data.token.refresh_token);
const clientId = data.clientId || (data.oauth2ClientSettings && data.oauth2ClientSettings.clientId);
const clientSecret = data.clientSecret || (data.oauth2ClientSettings && data.oauth2ClientSettings.clientSecret);

if (!refreshToken || !clientId || !clientSecret) {
  throw new Error('Incomplete clasp credentials: refresh_token, clientId, and clientSecret are required.');
}

console.log('âœ… CLASPRC_JSON looks valid and contains required tokens.');
NODE

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: clasp push
        run: npx clasp push -f

      - name: clasp deploy (tag/workflow_dispatch only)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        env:
          CLASP_DEPLOYMENT_ID: ${{ secrets.CLASP_DEPLOYMENT_ID }}
        run: |
          DESC="CI deploy ${GITHUB_REF_NAME:-manual} @ ${GITHUB_SHA}"
          if [ -n "$CLASP_DEPLOYMENT_ID" ]; then
            npx clasp deploy -i "$CLASP_DEPLOYMENT_ID" -d "$DESC"
          else
            npx clasp deploy -d "$DESC"
          fi
