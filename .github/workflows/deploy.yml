name: Deploy to Apps Script

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: "apps-script-deploy"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Validate clasp config
        run: |
          if [ ! -f ".clasp.json" ]; then
            echo "::error::.clasp.json is missing. Copy .clasp.json.example and set scriptId before deploying."
            exit 1
          fi

          SCRIPT_ID=$(node -e "const fs = require('fs'); const path = '.clasp.json'; const json = JSON.parse(fs.readFileSync(path, 'utf8')); console.log((json.scriptId || '').trim());")

          if [ -z "$SCRIPT_ID" ] || [ "$SCRIPT_ID" = "REPLACE_WITH_SCRIPT_ID" ]; then
            echo "::error::.clasp.json scriptId is missing. Update scriptId with your Apps Script project ID and commit before deploying."
            exit 1
          fi

          echo "Detected scriptId in .clasp.json; continuing deployment."

      - name: Validate clasp auth secret
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = `${process.env.HOME}/.clasprc.json`;
          const source = process.env.CLASPRC_JSON ?? '';

          if (!source.trim()) {
            throw new Error(
              "Missing CLASPRC_JSON secret. Run 'npx clasp login --no-localhost' and paste the Base64 block from 'npm run check:clasprc -- --print --base64' into the CLASPRC_JSON repository secret (raw JSON is also accepted)."
            );
          }

          const attemptParse = (value) => {
            try {
              return JSON.parse(value);
            } catch (error) {
              return undefined;
            }
          };

          const decodeClasprc = (raw) => {
            const trimmed = raw.trim();
            if (!trimmed) {
              throw new Error(
                'CLASPRC_JSON is set but empty. Paste the Base64 block from `npm run check:clasprc -- --print --base64` (preferred) or the raw ~/.clasprc.json content.'
              );
            }

            let decodedRaw = trimmed;
            let format = 'json';
            let data = attemptParse(decodedRaw);

            if (!data) {
              try {
                const maybeDecoded = Buffer.from(trimmed, 'base64')
                  .toString('utf8')
                  .trim();
                if (maybeDecoded) {
                  const maybeParsed = attemptParse(maybeDecoded);
                  if (maybeParsed) {
                    decodedRaw = maybeDecoded;
                    data = maybeParsed;
                    format = 'base64';
                  }
                }
              } catch (error) {
                // continue to unified failure below
              }
            }

            if (!data) {
              throw new Error(
                'Failed to parse CLASPRC_JSON as JSON or base64-encoded JSON. Regenerate with `npm run check:clasprc -- --print --base64` and paste the Base64 block into the secret.'
              );
            }

            return { data, decodedRaw, format };
          };

          const { data, decodedRaw, format } = decodeClasprc(source);

          fs.writeFileSync(path, decodedRaw, 'utf8');

          const pickFirst = (...candidates) =>
            candidates.find((value) => typeof value === 'string' && value.trim())?.trim();

          const pickFromTokens = (fieldNames) => {
            const tokens = data.tokens;
            if (!tokens || typeof tokens !== 'object') return [];

            const ordered = [];
            if (tokens.default && typeof tokens.default === 'object') ordered.push(tokens.default);
            for (const [key, token] of Object.entries(tokens)) {
              if (key === 'default') continue;
              if (token && typeof token === 'object') ordered.push(token);
            }

            const out = [];
            for (const token of ordered) {
              for (const name of fieldNames) {
                const value = token[name];
                if (typeof value === 'string' && value.trim()) {
                  out.push(value.trim());
                  break;
                }
              }
            }
            return out;
          };

          const refreshToken = pickFirst(
            data.refresh_token,
            data.token?.refresh_token,
            data.token?.refreshToken,
            ...pickFromTokens(['refresh_token', 'refreshToken'])
          );

          const clientId = pickFirst(
            data.clientId,
            data.oauth2ClientSettings?.clientId,
            data.client_id,
            ...pickFromTokens(['clientId', 'client_id'])
          );

          const clientSecret = pickFirst(
            data.clientSecret,
            data.oauth2ClientSettings?.clientSecret,
            data.client_secret,
            ...pickFromTokens(['clientSecret', 'client_secret'])
          );

          const missing = [];
          if (!refreshToken) missing.push('refresh_token');
          if (!clientId) missing.push('clientId');
          if (!clientSecret) missing.push('clientSecret');

          if (missing.length) {
            throw new Error(
              `Incomplete clasp credentials: missing ${missing.join(
                ', '
              )}. Re-run 'npx clasp login --no-localhost' and paste the Base64 block from \`npm run check:clasprc -- --print --base64\` into the CLASPRC_JSON secret (raw JSON also works).`
            );
          }

          console.log(
            `âœ… CLASPRC_JSON looks valid and contains required tokens (${format}).`
          );
          NODE

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: clasp push
        run: npx clasp push -f

      - name: clasp deploy (tag/workflow_dispatch only)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        env:
          CLASP_DEPLOYMENT_ID: ${{ secrets.CLASP_DEPLOYMENT_ID }}
        run: |
          DESC="CI deploy ${GITHUB_REF_NAME:-manual} @ ${GITHUB_SHA}"
          if [ -n "$CLASP_DEPLOYMENT_ID" ]; then
            npx clasp deploy -i "$CLASP_DEPLOYMENT_ID" -d "$DESC"
          else
            npx clasp deploy -d "$DESC"
          fi
