name: CI

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Evaluate GAS readiness or bootstrap request
        id: gas
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const claspPath = '.clasp.json';
          const requestPath = '.gas/request.json';

          const readScriptId = (value) => {
            const id = (value || '').trim();
            if (!id || id === 'REPLACE_WITH_SCRIPT_ID') return '';
            return id;
          };

          let scriptId = '';
          let hasClasp = false;
          if (fs.existsSync(claspPath)) {
            try {
              const json = JSON.parse(fs.readFileSync(claspPath, 'utf8'));
              scriptId = readScriptId(json.scriptId);
              hasClasp = true;
            } catch (error) {
              console.error('::error::.clasp.json is not valid JSON:', error);
              process.exit(1);
            }
          }

          let requestKind = '';
          let requestEnabled = false;
          if (fs.existsSync(requestPath)) {
            try {
              const request = JSON.parse(fs.readFileSync(requestPath, 'utf8'));
              requestKind = request.kind || '';
              requestEnabled = request.enabled !== false;
            } catch (error) {
              console.error('::error::.gas/request.json is not valid JSON:', error);
              process.exit(1);
            }
          }

          const ready = Boolean(scriptId);
          const hasBootstrap = requestKind === 'gas.bootstrap';

          if (!ready && !hasBootstrap) {
            console.error('::error::Missing valid .clasp.json (scriptId), and no bootstrap request found at .gas/request.json.');
            process.exit(1);
          }

          if (!ready && hasBootstrap) {
            const suffix = requestEnabled ? '' : ' (request is currently disabled)';
            console.warn(`::warning::Bootstrap request detected; skipping .clasp.json validation${suffix}.`);
          }

          const outputs = {
            ready,
            scriptId,
            hasClasp,
            requestKind,
            requestEnabled,
          };

          const out = Object.entries(outputs)
            .map(([key, value]) => `${key}=${String(value).replace(/%/g, '%25').replace(/\n/g, '%0A').replace(/\r/g, '%0D')}`)
            .join('\n');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `${out}\n`);

          if (ready) {
            console.log(`Detected scriptId in .clasp.json; continuing checks.`);
          }
          NODE

      - name: Validate clasp auth secret
        if: steps.gas.outputs.ready == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = `${process.env.HOME}/.clasprc.json`;
          const source = process.env.CLASPRC_JSON ?? '';

          if (!source.trim()) {
            throw new Error(
              "Missing CLASPRC_JSON secret. Run 'npx clasp login --no-localhost' and paste the Base64 block from 'npm run check:clasprc -- --print --base64' into the CLASPRC_JSON repository secret (raw JSON is also accepted)."
            );
          }

          const attemptParse = (value) => {
            try {
              return JSON.parse(value);
            } catch (error) {
              return undefined;
            }
          };

          const decodeClasprc = (raw) => {
            const trimmed = raw.trim();
            if (!trimmed) {
              throw new Error(
                'CLASPRC_JSON is set but empty. Paste the Base64 block from `npm run check:clasprc -- --print --base64` (preferred) or the raw ~/.clasprc.json content.'
              );
            }

            let decodedRaw = trimmed;
            let format = 'json';
            let data = attemptParse(decodedRaw);

            if (!data) {
              try {
                const maybeDecoded = Buffer.from(trimmed, 'base64')
                  .toString('utf8')
                  .trim();
                if (maybeDecoded) {
                  const maybeParsed = attemptParse(maybeDecoded);
                  if (maybeParsed) {
                    decodedRaw = maybeDecoded;
                    data = maybeParsed;
                    format = 'base64';
                  }
                }
              } catch (error) {
                // continue to unified failure below
              }
            }

            if (!data) {
              throw new Error(
                'Failed to parse CLASPRC_JSON as JSON or base64-encoded JSON. Regenerate with `npm run check:clasprc -- --print --base64` and paste the Base64 block into the secret.'
              );
            }

            return { data, decodedRaw, format };
          };

          const { data, decodedRaw, format } = decodeClasprc(source);

          fs.writeFileSync(path, decodedRaw, 'utf8');

          const pickFirst = (...candidates) =>
            candidates.find((value) => typeof value === 'string' && value.trim())?.trim();

          const pickFromTokens = (fieldNames) => {
            const tokens = data.tokens;
            if (!tokens || typeof tokens !== 'object') return [];

            const ordered = [];
            if (tokens.default && typeof tokens.default === 'object') ordered.push(tokens.default);
            for (const [key, token] of Object.entries(tokens)) {
              if (key === 'default') continue;
              if (token && typeof token === 'object') ordered.push(token);
            }

            const out = [];
            for (const token of ordered) {
              for (const name of fieldNames) {
                const value = token[name];
                if (typeof value === 'string' && value.trim()) {
                  out.push(value.trim());
                  break;
                }
              }
            }
            return out;
          };

          const refreshToken = pickFirst(
            data.refresh_token,
            data.token?.refresh_token,
            data.token?.refreshToken,
            ...pickFromTokens(['refresh_token', 'refreshToken'])
          );

          const clientId = pickFirst(
            data.clientId,
            data.oauth2ClientSettings?.clientId,
            data.client_id,
            ...pickFromTokens(['clientId', 'client_id'])
          );

          const clientSecret = pickFirst(
            data.clientSecret,
            data.oauth2ClientSettings?.clientSecret,
            data.client_secret,
            ...pickFromTokens(['clientSecret', 'client_secret'])
          );

          const missing = [];
          if (!refreshToken) missing.push('refresh_token');
          if (!clientId) missing.push('clientId');
          if (!clientSecret) missing.push('clientSecret');

          if (missing.length) {
            throw new Error(
              `Incomplete clasp credentials: missing ${missing.join(
                ', '
              )}. Re-run 'npx clasp login --no-localhost' and paste the Base64 block from \`npm run check:clasprc -- --print --base64\` into the CLASPRC_JSON secret (raw JSON also works).`
            );
          }

          console.log(
            `âœ… CLASPRC_JSON looks valid and contains required tokens (${format}).`
          );
          NODE

      - name: Skip secret validation for non-main runs
        if: github.event_name != 'push' || github.ref != 'refs/heads/main'
        run: echo "::warning::Skipping CLASPRC_JSON validation outside main branch pushes."

  ci:
    needs: guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Typecheck
        run: npm run typecheck --if-present

      - name: Test
        run: npm test --if-present

      - name: Build
        run: npm run build
