name: CI

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate clasp config
        run: |
          if [ ! -f ".clasp.json" ]; then
            echo "::error::.clasp.json is missing. Copy .clasp.json.example and set scriptId before working on GAS code."
            exit 1
          fi

          SCRIPT_ID=$(node -e "const fs = require('fs'); const path = '.clasp.json'; const json = JSON.parse(fs.readFileSync(path, 'utf8')); console.log((json.scriptId || '').trim());")

          if [ -z "$SCRIPT_ID" ] || [ "$SCRIPT_ID" = "REPLACE_WITH_SCRIPT_ID" ]; then
            echo "::error::.clasp.json scriptId is missing or still REPLACE_WITH_SCRIPT_ID. Update scriptId with your Apps Script project ID before continuing."
            exit 1
          fi

          echo "Detected scriptId in .clasp.json; continuing checks."

      - name: Validate clasp auth secret
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = `${process.env.HOME}/.clasprc.json`;
          const source = process.env.CLASPRC_JSON ?? '';

          if (!source.trim()) {
            throw new Error(
              "Missing CLASPRC_JSON secret. Run 'npx clasp login --no-localhost' and paste the Base64 block from 'npm run check:clasprc -- --print --base64' into the CLASPRC_JSON repository secret (raw JSON is also accepted)."
            );
          }

          const attemptParse = (value) => {
            try {
              return JSON.parse(value);
            } catch (error) {
              return undefined;
            }
          };

          const decodeClasprc = (raw) => {
            const trimmed = raw.trim();
            if (!trimmed) {
              throw new Error(
                'CLASPRC_JSON is set but empty. Paste the Base64 block from `npm run check:clasprc -- --print --base64` (preferred) or the raw ~/.clasprc.json content.'
              );
            }

            let decodedRaw = trimmed;
            let format = 'json';
            let data = attemptParse(decodedRaw);

            if (!data) {
              try {
                const maybeDecoded = Buffer.from(trimmed, 'base64')
                  .toString('utf8')
                  .trim();
                if (maybeDecoded) {
                  const maybeParsed = attemptParse(maybeDecoded);
                  if (maybeParsed) {
                    decodedRaw = maybeDecoded;
                    data = maybeParsed;
                    format = 'base64';
                  }
                }
              } catch (error) {
                // continue to unified failure below
              }
            }

            if (!data) {
              throw new Error(
                'Failed to parse CLASPRC_JSON as JSON or base64-encoded JSON. Regenerate with `npm run check:clasprc -- --print --base64` and paste the Base64 block into the secret.'
              );
            }

            return { data, decodedRaw, format };
          };

          const { data, decodedRaw, format } = decodeClasprc(source);

          fs.writeFileSync(path, decodedRaw, 'utf8');

          const pickFirst = (...candidates) =>
            candidates.find((value) => typeof value === 'string' && value.trim())?.trim();

          const refreshToken = pickFirst(data.refresh_token, data.token?.refresh_token);
          const clientId = pickFirst(data.clientId, data.oauth2ClientSettings?.clientId);
          const clientSecret = pickFirst(
            data.clientSecret,
            data.oauth2ClientSettings?.clientSecret
          );

          const missing = [];
          if (!refreshToken) missing.push('refresh_token');
          if (!clientId) missing.push('clientId');
          if (!clientSecret) missing.push('clientSecret');

          if (missing.length) {
            throw new Error(
              `Incomplete clasp credentials: missing ${missing.join(
                ', '
              )}. Re-run 'npx clasp login --no-localhost' and paste the Base64 block from \`npm run check:clasprc -- --print --base64\` into the CLASPRC_JSON secret (raw JSON also works).`
            );
          }

          console.log(
            `âœ… CLASPRC_JSON looks valid and contains required tokens (${format}).`
          );
          NODE

      - name: Skip secret validation for non-main runs
        if: github.event_name != 'push' || github.ref != 'refs/heads/main'
        run: echo "::warning::Skipping CLASPRC_JSON validation outside main branch pushes."

  ci:
    needs: guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Typecheck
        run: npm run typecheck --if-present

      - name: Test
        run: npm test --if-present

      - name: Build
        run: npm run build
